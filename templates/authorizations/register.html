{% import 'lib.twig' as lib %}
{{ title(__('title_register')) }}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-12 d-flex justify-content-center align-items-center">
            {% if not created %}
                <!-- Add reCAPTCHA script only when form is shown -->
                <script src="https://www.google.com/recaptcha/api.js?render={{ config.recaptcha.site_key }}"></script>

                <div class="login-form-container">
                    <h3 class="display-4 text-center">{{ __('title_register') }}</h3>
                    <br />

                    <form method="post" id="registration" class="needs-validation" name="registration" novalidate>
                        {{ filter('form_begin', 'registration') |raw }}
                        <div class="mb-3">
                            <input type="email" class="form-control" id="email" name="email"
                                   placeholder="{{ __('hint_email') }}"
                                   maxlength="100" required>
                            <div class="invalid-feedback">
                                Please provide a valid email.
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="name" placeholder="{{ __('label_name') }}"
                                   name="name" minlength="3" maxlength="100" required>
                            <div class="invalid-feedback">
                                Please provide a valid name.
                            </div>
                        </div>
                        <div class="mb-3">
                            <select class="form-select" id="isMale" name="isMale" required>
                                <option selected disabled>{{ __('label_gender') }}...</option>
                                <option value="X">{{ __('label_nogender') }}</option>
                                <option value="F">{{ __('label_female') }}</option>
                                <option value="M">{{ __('label_male') }}</option>
                                <option value="O">{{ __('label_othergender') }}</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a gender.
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="profession"
                                   placeholder="{{ __('label_profession') }}" name="profession" minlength="3"
                                   maxlength="100" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="employer"
                                   placeholder="{{ __('label_employer') }}" name="employer" minlength="3"
                                   maxlength="100">
                        </div>

                        <!-- Hidden field for reCAPTCHA token -->
                        <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response">

                        <button type="submit" id="submit-btn" class="mt-3 btn btn-primary">
                            <span class="fg-ok"><span class="bi bi-envelope"></span></span>
                            {{ __('label_emailconfirm') }}
                        </button>
                    </form>
                </div>

                <!-- JavaScript only runs when form is present -->
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const form = document.getElementById('registration');
                        const submitBtn = document.getElementById('submit-btn');

                        if (form && submitBtn) {
                            form.addEventListener('submit', function(e) {
                                e.preventDefault();

                                // Check form validation
                                if (!form.checkValidity()) {
                                    form.classList.add('was-validated');
                                    return;
                                }

                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';

                                // Check if grecaptcha is loaded
                                if (typeof grecaptcha === 'undefined') {
                                    alert('reCAPTCHA failed to load. Please refresh the page.');
                                    resetButton();
                                    return;
                                }

                                grecaptcha.ready(function() {
                                    const siteKey = '{{ config.recaptcha.site_key }}';

                                    grecaptcha.execute(siteKey, {action: 'registration'})
                                        .then(function(token) {
                                            if (!token) {
                                                alert('reCAPTCHA failed to generate token. Please try again.');
                                                resetButton();
                                                return;
                                            }

                                            const hiddenField = document.getElementById('g-recaptcha-response');
                                            if (hiddenField) {
                                                hiddenField.value = token;
                                            }

                                            form.submit();
                                        })
                                        .catch(function(error) {
                                            resetButton();
                                            alert('reCAPTCHA verification failed. Please try again.');
                                        });
                                });

                                function resetButton() {
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = '<span class="fg-ok"><span class="bi bi-envelope"></span></span> {{ __("label_emailconfirm") }}';
                                }
                            });
                        }
                    });
                </script>
            {% endif %}

            {% if created %}
                {% if success %}
                    <div class="card border-success mb-3" id="successCard">
                        <div class="card-body text-success">
                            <h5 class="card-title">{{ __('label_login')|raw }}</h5>
                            <p class="card-text">{{ __('info_mailclick')|raw }}</p>
                            <a class="btn btn-dark mt-3 float-end" href="{{ req.base }}/">{{ __('label_back_to_login') }}</a>
                        </div>
                    </div>
                {% else %}
                    <div class="card border-danger mb-3" id="failureCard">
                        <div class="card-body text-danger">
                            <h5 class="card-title">{{ __('label_login')|raw }}</h5>
                            <p class="card-text">
                                {% if error == 'recaptcha_failed' %}
                                    {{ __('recaptcha_failed') }}
                                {% else %}
                                    {{ __('register_failure') }}
                                {% endif %}
                            </p>
                            <a class="btn btn-dark mt-3 float-end" href="{{ req.base }}/">{{ __('label_back_to_login') }}</a>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<style>
    .login-form-container {
        max-width: 490px;
        width: 100%;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: #fff;
        border-radius: 10px;
    }

    .login-form .form-control {
        font-size: 1rem;
        height: auto;
        padding: 10px 20px;
        margin-bottom: 15px;
    }

    .login-form .btn {
        padding: 10px 15px;
        font-size: 0.9rem;
        font-weight: 600;
    }
</style>